name: CI

on:
  push:
    branches: [main]
  pull_request:
  release:
    types: [published]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install Lua and dependencies
        run: sudo apt-get install -y lua5.4 liblua5.4-dev luarocks

      - name: Install rock from local source
        run: luarocks --lua-version 5.4 make --local

      - name: Run busted tests
        env:
          ROUTEX_URL: ${{ secrets.ROUTEX_URL }}
          KEY_ID: test
          KEY: ${{ secrets.ROUTEX_KEY }}
        run: luarocks --lua-version 5.4 test --local

      - name: Smoke test
        env:
          ROUTEX_URL: ${{ secrets.ROUTEX_URL }}
        run: |
          eval "$(luarocks --lua-version 5.4 path)"
          lua5.4 .github/scripts/smoke_test.lua

  publish:
    needs: test
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'release'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install luarocks
        run: sudo apt-get install -y luarocks lua-cjson

      - name: Upload scm rockspec
        if: github.event_name == 'push'
        run: luarocks upload --skip-pack --force --api-key=${{ secrets.LUAROCKS_API_KEY }} routex-client-scm-1.rockspec

      - name: Build and upload versioned rock
        if: github.event_name == 'release'
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          ROCKSPEC="routex-client-${VERSION}-1.rockspec"
          sed 's/local package_version = "scm"/local package_version = "'"${VERSION}"'"/' \
            routex-client-scm-1.rockspec > "$ROCKSPEC"
          luarocks pack "$ROCKSPEC"
          luarocks upload --api-key=${{ secrets.LUAROCKS_API_KEY }} "$ROCKSPEC" "routex-client-${VERSION}-1.src.rock"
